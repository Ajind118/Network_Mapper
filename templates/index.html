<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Network Mapper</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <style>
        body {
            background-color: #f0f2f5;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .header {
            background: linear-gradient(135deg, #0d6efd, #6f42c1);
            color: white;
            padding: 4rem 0;
            text-align: center;
            border-bottom-left-radius: 50% 20%;
            border-bottom-right-radius: 50% 20%;
        }
        .card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.05);
            transition: transform 0.3s, box-shadow 0.3s;
        }
        .card:hover {
            transform: translateY(-10px);
            box-shadow: 0 15px 30px rgba(0,0,0,0.1);
        }
        .progress-bar {
            transition: width 0.4s ease-in-out;
        }
        .status-card {
            background-color: #ffffff;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.05);
        }
        .results-container {
            max-height: 400px;
            overflow-y: auto;
        }
        .list-group-item {
            border-radius: 10px !important;
            margin-bottom: 10px;
            border: 1px solid #e9ecef;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in {
            animation: fadeIn 0.5s ease-out forwards;
        }
    </style>
</head>
<body>

<div class="header">
    <h1 class="display-4"><i class="bi bi-diagram-3-fill"></i> Network Mapper</h1>
    <p class="lead">An intuitive tool for network discovery and visualization.</p>
</div>

<div class="container" style="margin-top: -50px;">
    <div class="row">
        <div class="col-lg-6 mb-4">
            <div class="card h-100">
                <div class="card-body text-center p-4">
                    <i class="bi bi-list-check" style="font-size: 3rem; color: var(--bs-primary);"></i>
                    <h4 class="my-3">Basic Discovery</h4>
                    <p class="text-muted">A quick and simple way to find all devices on your network.</p>
                    <div class="input-group mb-3">
                        <input type="text" id="ip_range" class="form-control" placeholder="e.g., 192.168.1.0/24">
                        <button class="btn btn-secondary" onclick="getLocalRange()"><i class="bi bi-house-gear"></i></button>
                    </div>
                    <button class="btn btn-primary w-100" onclick="startScan('Discovery')"><i class="bi bi-search"></i> Discover Hosts</button>
                </div>
            </div>
        </div>
        <div class="col-lg-6 mb-4">
            <div class="card h-100">
                <div class="card-body text-center p-4 d-flex flex-column justify-content-center">
                    <i class="bi bi-diagram-3" style="font-size: 3rem; color: var(--bs-success);"></i>
                    <h4 class="my-3">Visual Mapping</h4>
                    <p class="text-muted">Explore your network with an interactive, graphical map.</p>
                    <a href="/visual" class="btn btn-success mt-auto"><i class="bi bi-graph-up"></i> Launch Visual Mapper</a>
                </div>
            </div>
        </div>
    </div>

    <div class="status-card mb-4">
        <div class="d-flex justify-content-between align-items-center mb-2">
            <h5 class="mb-0"><i class="bi bi-activity"></i> Scan Status</h5>
            <p id="status-text" class="mb-0 text-muted fw-medium">Idle</p>
        </div>
        <div class="progress" style="height: 10px;">
            <div id="progress-bar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%"></div>
        </div>
        <p id="progress-info" class="text-center small mt-2 text-muted"></p>
    </div>

    <div class="card">
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="mb-0"><i class="bi bi-list-ul"></i> Scan Results</h5>
                <div>
                    <button class="btn btn-success btn-sm" onclick="saveCurrentScan()" id="save-btn" disabled>
                        <i class="bi bi-floppy"></i> Save
                    </button>
                    <button class="btn btn-info btn-sm" onclick="showSavedScans()">
                        <i class="bi bi-clock-history"></i> View Saved
                    </button>
                </div>
            </div>
            <div class="results-container">
                <ul id="results" class="list-group list-group-flush"></ul>
            </div>
        </div>
    </div>
</div>

<!-- Saved Results Modal -->
<div class="modal fade" id="savedScansModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-clock-history"></i> Saved Scan Results</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="saved-scans-list" class="list-group">
                    <!-- Saved scans will be loaded here -->
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
let isScanning = false;
let currentScanId = null;
let pollInterval = null;
let lastProgress = 0;

function getLocalRange() {
    fetch("/api/localrange")
        .then(res => res.json())
        .then(data => {
            document.getElementById("ip_range").value = data.range;
        });
}

function startScan(phase) {
    if (isScanning) {
        alert("A scan is already in progress. Please wait for it to complete.");
        return;
    }
    
    const target = document.getElementById("ip_range").value;
    if (!target) {
        alert("Please enter a target IP range.");
        return;
    }
    
    // Reset UI
    document.getElementById("progress-bar").style.width = "0%";
    document.getElementById("progress-text").innerText = "0%";
    document.getElementById("status-text").innerText = "Starting scan...";
    document.getElementById("save-btn").disabled = true;
    document.getElementById("save-btn").innerHTML = '<i class="bi bi-floppy"></i> Save Result';
    document.getElementById("scan-controls").style.display = "block";
    document.getElementById("results").innerHTML = "";
    
    isScanning = true;
    lastProgress = 0;
    
    // Clear any existing interval
    if (pollInterval) {
        clearInterval(pollInterval);
    }
    
    // Start polling immediately
    pollInterval = setInterval(pollStatus, 1000);
    
    // Reset the scan data first
    fetch("/api/reset_scan", {
        method: "POST",
        headers: {"Content-Type": "application/json"}
    })
    .then(() => {
        fetch("/api/scan", {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({target: target, phase: phase})
        })
        .then(res => res.json())
        .then(data => {
            if (data.status === "error") {
                alert("Error starting scan: " + data.message);
                isScanning = false;
                clearInterval(pollInterval);
                document.getElementById("scan-controls").style.display = "none";
            } else {
                document.getElementById("status-text").innerText = "Scan started...";
            }
        })
        .catch(error => {
            console.error("Error starting scan:", error);
            alert("Error starting scan: " + error);
            isScanning = false;
            clearInterval(pollInterval);
            document.getElementById("scan-controls").style.display = "none";
        });
    })
    .catch(error => {
        console.error("Error resetting scan:", error);
        alert("Error resetting scan: " + error);
        isScanning = false;
        clearInterval(pollInterval);
        document.getElementById("scan-controls").style.display = "none";
    });
}

function stopScan() {
    if (!isScanning) return;
    
    if (confirm('Are you sure you want to stop the current scan?')) {
        isScanning = false;
        if (pollInterval) {
            clearInterval(pollInterval);
        }
        document.getElementById("scan-controls").style.display = "none";
        document.getElementById("status-text").innerText = "Scan stopped by user";
        document.getElementById("progress-bar").classList.remove("progress-bar-animated");
    }
}

function pollStatus() {
    if (!isScanning) return;
    
    fetch("/api/status?" + new Date().getTime()) // Prevent caching
        .then(res => res.json())
        .then(data => {
            const statusText = document.getElementById("status-text");
            const progressBar = document.getElementById("progress-bar");
            const progressText = document.getElementById("progress-text");
            const currentTarget = document.getElementById("current-target");
            const progressInfo = document.getElementById("progress-info");

            // Update status and progress
            statusText.innerText = (data.phase || "Scanning") + " - " + (data.status || "running");
            
            // Ensure progress is never more than 100%
            const progress = Math.min(100, data.progress || 0);
            
            // Only update if progress actually changed
            if (progress !== lastProgress) {
                progressBar.style.width = progress + "%";
                progressText.innerText = progress + "%";
                lastProgress = progress;
            }
            
            if (data.status === "running" && data.current_host) {
                currentTarget.innerText = data.current_host;
                
                // Show progress information if available
                if (data.scanned_hosts !== undefined && data.total_hosts !== undefined) {
                    const foundCount = data.results && data.results.hosts ? data.results.hosts.length : 0;
                    progressInfo.innerText = `Scanned ${data.scanned_hosts} of ${data.total_hosts} hosts - Found ${foundCount} devices`;
                } else {
                    progressInfo.innerText = "";
                }
            } else {
                currentTarget.innerText = "";
                progressInfo.innerText = "";
            }

            if (data.status === "done") {
                statusText.innerText = "Discovery Complete!";
                isScanning = false;
                if (pollInterval) {
                    clearInterval(pollInterval);
                }
                document.getElementById("scan-controls").style.display = "none";
                
                // Enable the save button
                document.getElementById('save-btn').disabled = false;
                currentScanId = data.scan_id;
                
                const resultsElem = document.getElementById("results");
                resultsElem.innerHTML = "";
                
                if (data.results && data.results.hosts && data.results.hosts.length > 0) {
                    data.results.hosts.forEach(host => {
                        let li = document.createElement("li");
                        li.className = "list-group-item fade-in";
                        li.innerHTML = `
                            <div class="d-flex justify-content-between align-items-center">
                                <span><i class="bi bi-pc-display-horizontal text-primary"></i> ${host}</span>
                                <div>
                                    <button onclick="openScanPage('${host}')" class="btn btn-sm btn-outline-primary scan-details-btn">
                                        Scan Details <i class="bi bi-search"></i>
                                    </button>
                                </div>
                            </div>
                        `;
                        resultsElem.appendChild(li);
                    });
                } else {
                    resultsElem.innerHTML = '<li class="list-group-item">No hosts found. The target might be down or unreachable.</li>';
                }
            } else if (data.status && data.status.startsWith("error")) {
                statusText.innerText = "Error: " + data.status;
                progressBar.classList.add("bg-danger");
                isScanning = false;
                if (pollInterval) {
                    clearInterval(pollInterval);
                }
                document.getElementById('save-btn').disabled = true;
                document.getElementById("scan-controls").style.display = "none";
            }
        })
        .catch(error => {
            console.error("Error polling status:", error);
            // Don't stop polling on network errors - retry will happen automatically
        });
}

function openScanPage(host) {
    // Open the detailed scan page in a new tab
    window.open(`/scan_host/${host}`, '_blank');
}

// Save and View functions
function saveCurrentScan() {
    const saveBtn = document.getElementById('save-btn');
    saveBtn.disabled = true;
    saveBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Saving...';
    
    fetch("/api/save_current_scan", {
        method: "POST",
        headers: {"Content-Type": "application/json"}
    })
    .then(res => res.json())
    .then(data => {
        if (data.status === "success") {
            alert("Scan saved successfully!");
            saveBtn.innerHTML = '<i class="bi bi-check"></i> Saved';
        } else {
            alert("Error saving scan: " + data.message);
            saveBtn.disabled = false;
            saveBtn.innerHTML = '<i class="bi bi-floppy"></i> Save Result';
        }
    })
    .catch(error => {
        alert("Error saving scan: " + error);
        saveBtn.disabled = false;
        saveBtn.innerHTML = '<i class="bi bi-floppy"></i> Save Result';
    });
}

function showSavedScans() {
    fetch("/api/saved_scans?type=discovery")
        .then(res => res.json())
        .then(data => {
            const scansList = document.getElementById('saved-scans-list');
            scansList.innerHTML = '';
            
            if (data.scans && data.scans.length > 0) {
                data.scans.forEach(scan => {
                    const scanItem = document.createElement('div');
                    scanItem.className = 'list-group-item';
                    scanItem.innerHTML = `
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="mb-1">${scan.target_range}</h6>
                                <small class="text-muted">
                                    ${new Date(scan.start_time).toLocaleString()} | 
                                    Hosts: ${scan.hosts_found} | 
                                    Duration: ${scan.duration_seconds}s
                                </small>
                            </div>
                            <div class="btn-group">
                                <button class="btn btn-sm btn-outline-primary" onclick="viewSavedScan(${scan.id})">
                                    <i class="bi bi-eye"></i> View
                                </button>
                                <button class="btn btn-sm btn-outline-danger" onclick="deleteSavedScan(${scan.id})">
                                    <i class="bi bi-trash"></i> Delete
                                </button>
                            </div>
                        </div>
                    `;
                    scansList.appendChild(scanItem);
                });
            } else {
                scansList.innerHTML = '<div class="text-center text-muted p-3">No saved scans found</div>';
            }
            
            new bootstrap.Modal(document.getElementById('savedScansModal')).show();
        });
}

function viewSavedScan(scanId) {
    // Open in new tab
    window.open(`/saved_scan/${scanId}`, '_blank');
}

function deleteSavedScan(scanId) {
    if (confirm('Are you sure you want to delete this saved scan?')) {
        fetch(`/api/delete_scan/${scanId}`, {
            method: 'DELETE'
        })
        .then(res => res.json())
        .then(data => {
            if (data.status === 'success') {
                alert('Scan deleted successfully!');
                showSavedScans(); // Refresh the list
            } else {
                alert('Error deleting scan: ' + data.message);
            }
        });
    }
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    getLocalRange();
});
</script>

</body>
</html>