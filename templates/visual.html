<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Network Visual Mapper</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <script src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
    <style>
        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .navbar {
            background: linear-gradient(135deg, #0d6efd, #6f42c1);
        }
        .main-container {
            padding: 20px;
        }
        .card {
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        #network {
            width: 100%;
            height: 600px;
            border: 1px solid #dee2e6;
            border-radius: 10px;
            background-color: #fff;
        }
        .device-icon {
            font-size: 24px;
            margin-right: 10px;
        }
        .custom-progress {
            height: 25px;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .custom-progress-bar {
            background: linear-gradient(45deg, #4facfe 0%, #00f2fe 100%);
            transition: width 0.5s ease-in-out;
        }
        .status-card {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .node-tooltip {
            position: absolute;
            background-color: rgba(255, 255, 255, 0.9);
            border: 1px solid #ccc;
            border-radius: 5px;
            padding: 10px;
            max-width: 300px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            pointer-events: none;
        }
        .btn:disabled {
            cursor: not-allowed;
            opacity: 0.6;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container">
            <a class="navbar-brand" href="#">
                <i class="bi bi-diagram-3"></i> Network Visual Mapper
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/"><i class="bi bi-arrow-left"></i> Back to Basic View</a>
            </div>
        </div>
    </nav>

    <div class="container main-container">
        <div class="row">
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <i class="bi bi-gear"></i> Scan Controls
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="ip_range" class="form-label">Target IP Range</label>
                            <input type="text" id="ip_range" class="form-control" placeholder="e.g., 192.168.1.0/24">
                        </div>
                        <div class="d-grid gap-2">
                            <button class="btn btn-primary" onclick="startVisualScan()">
                                <i class="bi bi-search"></i> Start Network Discovery
                            </button>
                            <button class="btn btn-secondary" onclick="autoDetectRange()">
                                <i class="bi bi-house-gear"></i> Auto Detect Network
                            </button>
                            <button class="btn btn-warning" onclick="resetScan()">
                                <i class="bi bi-arrow-clockwise"></i> Reset Scan
                            </button>
                        </div>

                        <!-- Save and View Buttons for Visual Scans -->
                        <div class="d-grid gap-2 mt-3">
                            <button class="btn btn-success" onclick="saveVisualScan()" id="save-visual-btn" disabled>
                                <i class="bi bi-floppy"></i> Save Visual Result
                            </button>
                            <button class="btn btn-info" onclick="showSavedScans()">
                                <i class="bi bi-clock-history"></i> View Saved Scans
                            </button>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header bg-info text-white">
                        <i class="bi bi-info-circle"></i> Legend
                    </div>
                    <div class="card-body">
                        <div class="d-flex align-items-center mb-2">
                            <i class="bi bi-router device-icon text-primary"></i>
                            <span>Router/Gateway</span>
                        </div>
                        <div class="d-flex align-items-center mb-2">
                            <i class="bi bi-microsoft device-icon text-success"></i>
                            <span>Windows Device</span>
                        </div>
                        <div class="d-flex align-items-center mb-2">
                            <i class="bi bi-ubuntu device-icon text-warning"></i>
                            <span>Linux Device</span>
                        </div>
                        <div class="d-flex align-items-center mb-2">
                            <i class="bi bi-android2 device-icon text-success"></i>
                            <span>Android Device</span>
                        </div>
                        <div class="d-flex align-items-center mb-2">
                            <i class="bi bi-apple device-icon text-dark"></i>
                            <span>Apple Device</span>
                        </div>
                        <div class="d-flex align-items-center mb-2">
                            <i class="bi bi-printer device-icon text-secondary"></i>
                            <span>Printer</span>
                        </div>
                        <div class="d-flex align-items-center mb-2">
                            <i class="bi bi-camera-video device-icon text-danger"></i>
                            <span>Camera</span>
                        </div>
                        <div class="d-flex align-items-center">
                            <i class="bi bi-pc device-icon text-info"></i>
                            <span>Unknown Device</span>
                        </div>
                    </div>
                </div>

                <div class="status-card">
                    <h5><i class="bi bi-graph-up"></i> Scan Status</h5>
                    <div class="custom-progress mt-3">
                        <div id="progress-bar" class="custom-progress-bar progress-bar-striped progress-bar-animated d-flex align-items-center justify-content-center" role="progressbar" style="width: 0%">
                            <span id="progress-text" class="fw-bold">0%</span>
                        </div>
                    </div>
                    <p id="status-text" class="mt-3 text-center fw-medium">Idle</p>
                    <p id="current-target" class="text-muted text-center mb-1"></p>
                    <p id="progress-info" class="progress-info text-center"></p>
                </div>
            </div>

            <div class="col-md-8">
                <div class="card">
                    <div class="card-header bg-success text-white">
                        <i class="bi bi-diagram-3"></i> Network Visualization
                    </div>
                    <div class="card-body">
                        <div id="network"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="node-tooltip" id="node-tooltip" style="display: none;"></div>

    <!-- Saved Scans Modal -->
    <div class="modal fade" id="savedScansModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-clock-history"></i> Saved Scans</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="saved-scans-list" class="list-group">
                        <!-- Saved scans will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let network = null;
        let nodes = null;
        let edges = null;
        let isScanning = false;
        let currentScanId = null;

        // Initialize network visualization
        function initNetwork() {
            const container = document.getElementById('network');
            const data = {
                nodes: new vis.DataSet(),
                edges: new vis.DataSet()
            };
            
            const options = {
                nodes: {
                    shape: 'dot',
                    size: 30,
                    font: {
                        size: 14,
                        face: 'Tahoma'
                    },
                    borderWidth: 2,
                    shadow: true
                },
                edges: {
                    width: 2,
                    shadow: true,
                    smooth: {
                        enabled: true,
                        type: 'continuous'
                    }
                },
                physics: {
                    stabilization: true,
                    barnesHut: {
                        gravitationalConstant: -80000,
                        springConstant: 0.001,
                        springLength: 200
                    }
                },
                interaction: {
                    tooltipDelay: 200,
                    hover: true,
                    navigationButtons: true,
                    keyboard: true
                }
            };
            
            network = new vis.Network(container, data, options);
            
            // Handle node clicks
            network.on("click", function(params) {
                if (params.nodes.length > 0) {
                    const nodeId = params.nodes[0];
                    showNodeDetails(nodeId);
                }
            });
            
            // Handle hover events for tooltips
            network.on("hoverNode", function(params) {
                const node = nodes.get(params.node);
                if (node) {
                    showTooltip(params.event, node);
                }
            });
            
            network.on("blurNode", function() {
                hideTooltip();
            });
        }
        
        // Show tooltip for node
        function showTooltip(event, node) {
            const tooltip = document.getElementById('node-tooltip');
            tooltip.innerHTML = `
                <strong>${node.label}</strong><br>
                ${node.title}<br>
                <button class="btn btn-sm btn-primary mt-2" onclick="scanNode('${node.id}')">
                    <i class="bi bi-search"></i> Scan Details
                </button>
            `;
            tooltip.style.display = 'block';
            tooltip.style.left = event.clientX + 10 + 'px';
            tooltip.style.top = event.clientY + 10 + 'px';
        }
        
        // Hide tooltip
        function hideTooltip() {
            const tooltip = document.getElementById('node-tooltip');
            tooltip.style.display = 'none';
        }
        
        // Scan a specific node
        function scanNode(ip) {
            window.open(`/scan_host/${ip}`, '_blank');
        }
        
        // Show node details
        function showNodeDetails(nodeId) {
            scanNode(nodeId);
        }
        
        // Load network graph data
        function loadNetworkGraph() {
            fetch('/api/network_graph')
                .then(response => response.json())
                .then(data => {
                    if (data.nodes && data.nodes.length > 0) {
                        updateNetworkGraph(data);
                    }
                })
                .catch(error => {
                    console.error("Error loading network graph:", error);
                });
        }
        
        // Update network graph with new data
        function updateNetworkGraph(graphData) {
            if (!network) return;
            
            // Clear existing data
            if (nodes) nodes.clear();
            if (edges) edges.clear();
            
            // Create new datasets
            nodes = new vis.DataSet(graphData.nodes.map(node => ({
                id: node.id,
                label: node.label,
                title: node.title,
                group: node.group,
                shape: 'circularImage',
                image: `https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/bootstrap-icons.svg#${node.icon}`,
                size: node.group === 'router' ? 40 : 30,
                color: getNodeColor(node.group)
            })));
            
            edges = new vis.DataSet(graphData.edges);
            
            // Update network
            network.setData({ nodes, edges });
        }

        // Create graph from saved scan data
        function createGraphFromSavedData(hosts) {
            fetch("/api/gateway")
                .then(res => res.json())
                .then(gatewayData => {
                    const gateway = gatewayData.gateway;
                    
                    const graphData = {
                        nodes: [],
                        edges: []
                    };

                    // Add gateway node
                    graphData.nodes.push({
                        id: gateway,
                        label: "Gateway",
                        title: `Default Gateway: ${gateway}`,
                        group: "router",
                        icon: "bi-router"
                    });

                    // Add host nodes
                    hosts.forEach(host => {
                        if (host.ip_address !== gateway) {
                            graphData.nodes.push({
                                id: host.ip_address,
                                label: host.ip_address,
                                title: `IP: ${host.ip_address}\nType: ${host.device_type || 'unknown'}`,
                                group: host.device_type || "unknown",
                                icon: getDeviceIcon(host.device_type || "unknown")
                            });

                            graphData.edges.push({
                                from: gateway,
                                to: host.ip_address,
                                label: "connected"
                            });
                        }
                    });

                    updateNetworkGraph(graphData);
                    new bootstrap.Modal(document.getElementById('savedScansModal')).hide();
                    alert('Network graph recreated from saved data!');
                });
        }
        
        // Get color for node based on group
        function getNodeColor(group) {
            const colors = {
                'router': { background: '#4facfe', border: '#00f2fe' },
                'windows': { background: '#198754', border: '#0f5132' },
                'linux': { background: '#ffc107', border: '#fd7e14' },
                'android': { background: '#198754', border: '#0f5132' },
                'apple': { background: '#212529', border: '#000' },
                'printer': { background: '#6c757d', border: '#495057' },
                'camera': { background: '#dc3545', border: '#b02a37' },
                'unknown': { background: '#0dcaf0', border: '#0aa2c0' }
            };
            
            return colors[group] || { background: '#0dcaf0', border: '#0aa2c0' };
        }

        // Get device icon
        function getDeviceIcon(deviceType) {
            const icons = {
                "router": "bi-router",
                "windows": "bi-microsoft", 
                "linux": "bi-ubuntu",
                "android": "bi-android2",
                "apple": "bi-apple",
                "printer": "bi-printer",
                "camera": "bi-camera-video",
                "unknown": "bi-pc"
            };
            return icons[deviceType] || "bi-pc";
        }
        
        // Auto detect network range
        function autoDetectRange() {
            fetch("/api/localrange")
                .then(res => res.json())
                .then(data => {
                    document.getElementById("ip_range").value = data.range;
                });
        }
        
        // Reset scan
        function resetScan() {
            fetch("/api/reset_scan", {
                method: "POST",
                headers: {"Content-Type": "application/json"}
            })
            .then(res => res.json())
            .then(data => {
                document.getElementById("status-text").innerText = "Scan reset";
                document.getElementById("progress-bar").style.width = "0%";
                document.getElementById("progress-text").innerText = "0%";
                document.getElementById("current-target").innerText = "";
                document.getElementById("progress-info").innerText = "";
                document.getElementById("save-visual-btn").disabled = true;
                document.getElementById("save-visual-btn").innerHTML = '<i class="bi bi-floppy"></i> Save Visual Result';
                isScanning = false;
                currentScanId = null;
                
                // Clear the network graph
                if (nodes) nodes.clear();
                if (edges) edges.clear();
            });
        }
        
        // Start visual scan
        function startVisualScan() {
            if (isScanning) {
                alert("A scan is already in progress. Please wait for it to complete.");
                return;
            }
            
            const target = document.getElementById("ip_range").value;
            if (!target) {
                alert("Please enter a target IP range.");
                return;
            }
            
            // Reset UI first
            document.getElementById("progress-bar").style.width = "0%";
            document.getElementById("progress-text").innerText = "0%";
            document.getElementById("status-text").innerText = "Starting scan...";
            document.getElementById("save-visual-btn").disabled = true;
            document.getElementById("save-visual-btn").innerHTML = '<i class="bi bi-floppy"></i> Save Visual Result';
            
            // Reset first
            resetScan();
            
            // Wait a bit for reset to complete
            setTimeout(function() {
                fetch("/api/visual_scan", {
                    method: "POST",
                    headers: {"Content-Type": "application/json"},
                    body: JSON.stringify({target: target, phase: "Discovery"})
                })
                .then(res => res.json())
                .then(data => {
                    document.getElementById("status-text").innerText = "Scan started...";
                    isScanning = true;
                    pollStatus();
                })
                .catch(error => {
                    console.error("Error starting scan:", error);
                    alert("Failed to start scan. Please try again.");
                });
            }, 500);
        }
        
        // Poll scan status
        function pollStatus() {
            if (!isScanning) return;
            
            fetch("/api/status")
                .then(res => res.json())
                .then(data => {
                    const statusText = document.getElementById("status-text");
                    const progressBar = document.getElementById("progress-bar");
                    const progressText = document.getElementById("progress-text");
                    const currentTarget = document.getElementById("current-target");
                    const progressInfo = document.getElementById("progress-info");

                    statusText.innerText = data.phase + " - " + data.status;
                    
                    // Ensure progress is never more than 100%
                    const progress = Math.min(100, data.progress);
                    progressBar.style.width = progress + "%";
                    progressText.innerText = progress + "%";
                    
                    if (data.status === "running" && data.current_host) {
                        currentTarget.innerText = data.current_host;
                        
                        // Show progress information if available
                        if (data.scanned_hosts !== undefined && data.total_hosts !== undefined) {
                            progressInfo.innerText = `Scanned ${data.scanned_hosts} of ${data.total_hosts} hosts - Found ${data.results.hosts ? data.results.hosts.length : 0} devices`;
                        } else {
                            progressInfo.innerText = "";
                        }
                    } else {
                        currentTarget.innerText = "";
                        progressInfo.innerText = "";
                    }

                    if (data.status === "running") {
                        setTimeout(pollStatus, 1000);
                    } else if (data.status === "done") {
                        statusText.innerText = "Discovery Complete!";
                        isScanning = false;
                        // Enable the save button
                        document.getElementById('save-visual-btn').disabled = false;
                        currentScanId = data.scan_id;
                        
                        // Load the network graph after scan completes
                        setTimeout(function() {
                            loadNetworkGraph();
                        }, 500);
                    } else if (data.status.startsWith("error")) {
                        if (data.status.includes("nmap")) {
                            statusText.innerHTML = `<strong>Error:</strong> 'nmap' is not installed. Please <a href="https://nmap.org/download.html" target="_blank" class="alert-link">install nmap</a> and restart the application.`;
                            statusText.className = 'mt-3 text-center fw-medium alert alert-danger';
                        } else {
                            statusText.innerText = "Error: " + data.status;
                        }
                        progressBar.classList.add("bg-danger");
                        isScanning = false;
                        document.getElementById('save-visual-btn').disabled = true;
                    }
                })
                .catch(error => {
                    console.error("Error polling status:", error);
                    // Retry after a delay
                    setTimeout(pollStatus, 2000);
                });
        }

        // Save and View functions
        function saveVisualScan() {
            const saveBtn = document.getElementById('save-visual-btn');
            saveBtn.disabled = true;
            saveBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Saving...';
            
            fetch("/api/save_current_scan", {
                method: "POST",
                headers: {"Content-Type": "application/json"}
            })
            .then(res => res.json())
            .then(data => {
                if (data.status === "success") {
                    alert("Visual scan saved successfully!");
                    saveBtn.innerHTML = '<i class="bi bi-check"></i> Saved';
                } else {
                    alert("Error saving scan: " + data.message);
                    saveBtn.disabled = false;
                    saveBtn.innerHTML = '<i class="bi bi-floppy"></i> Save Visual Result';
                }
            })
            .catch(error => {
                alert("Error saving scan: " + error);
                saveBtn.disabled = false;
                saveBtn.innerHTML = '<i class="bi bi-floppy"></i> Save Visual Result';
            });
        }
        // Save and View functions
    function saveCurrentScan() {
        const saveBtn = document.getElementById('save-btn');
        saveBtn.disabled = true;
        saveBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Saving...';
    
        fetch("/api/save_current_scan", {
        method: "POST",
        headers: {"Content-Type": "application/json"}
        })
        .then(res => res.json())
        .then(data => {
        if (data.status === "success") {
            alert("Scan saved successfully!");
            saveBtn.innerHTML = '<i class="bi bi-check"></i> Saved';
        } else {
            alert("Error saving scan: " + data.message);
            saveBtn.disabled = false;
            saveBtn.innerHTML = '<i class="bi bi-floppy"></i> Save Result';
        }
        })
        .catch(error => {
        alert("Error saving scan: " + error);
        saveBtn.disabled = false;
        saveBtn.innerHTML = '<i class="bi bi-floppy"></i> Save Result';
        });
}

        function showSavedScans() {
            fetch("/api/saved_scans")
                .then(res => res.json())
                .then(data => {
                    const scansList = document.getElementById('saved-scans-list');
                    scansList.innerHTML = '';
                    
                    if (data.scans && data.scans.length > 0) {
                        data.scans.forEach(scan => {
                            const scanItem = document.createElement('div');
                            scanItem.className = 'list-group-item';
                            scanItem.innerHTML = `
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h6 class="mb-1">${scan.target_range}</h6>
                                        <small class="text-muted">
                                            ${new Date(scan.start_time).toLocaleString()} | 
                                            Type: ${scan.scan_type} |
                                            Hosts: ${scan.hosts_found} | 
                                            Duration: ${scan.duration_seconds}s
                                        </small>
                                    </div>
                                    <div class="btn-group">
                                        <button class="btn btn-sm btn-outline-primary" onclick="loadSavedScan(${scan.id})">
                                            <i class="bi bi-graph-up"></i> Create Graph
                                        </button>
                                        <button class="btn btn-sm btn-outline-info" onclick="viewSavedScanDetails(${scan.id})">
                                            <i class="bi bi-eye"></i> Details
                                        </button>
                                        <button class="btn btn-sm btn-outline-danger" onclick="deleteSavedScan(${scan.id})">
                                            <i class="bi bi-trash"></i> Delete
                                        </button>
                                    </div>
                                </div>
                            `;
                            scansList.appendChild(scanItem);
                        });
                    } else {
                        scansList.innerHTML = '<div class="text-center text-muted p-3">No saved scans found</div>';
                    }
                    
                    new bootstrap.Modal(document.getElementById('savedScansModal')).show();
                });
        }

        function loadSavedScan(scanId) {
            fetch(`/api/saved_scan/${scanId}`)
                .then(res => res.json())
                .then(data => {
                    if (data.status === 'success' && data.scan.hosts) {
                        createGraphFromSavedData(data.scan.hosts);
                    } else {
                        alert('No scan data found');
                    }
                });
        }

        function viewSavedScanDetails(scanId) {
            window.open(`/saved_scan/${scanId}`, '_blank');
        }

        function deleteSavedScan(scanId) {
            if (confirm('Are you sure you want to delete this saved scan?')) {
                fetch(`/api/delete_scan/${scanId}`, {
                    method: 'DELETE'
                })
                .then(res => res.json())
                .then(data => {
                    if (data.status === 'success') {
                        alert('Scan deleted successfully!');
                        showSavedScans(); // Refresh the list
                    } else {
                        alert('Error deleting scan: ' + data.message);
                    }
                });
            }
        }
        
        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            initNetwork();
            autoDetectRange();
        });
    </script>
</body>
</html>